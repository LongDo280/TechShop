@model IEnumerable<TechShop1.ViewModels.CartItem>
@{
	ViewData["Title"] = "CheckOut";
	var totalAmountVND = Model.Sum(x => x.ThanhTien);
}

<!-- Page Header -->
<div class="container-fluid page-header py-5">
	<h1 class="text-center text-white display-6">Checkout</h1>
	<ol class="breadcrumb justify-content-center mb-0">
		<li class="breadcrumb-item"><a href="/">Home</a></li>
		<li class="breadcrumb-item active text-white">Checkout</li>
	</ol>
</div>

<!-- Checkout Page -->
<div class="container-fluid py-5">
	<div class="container py-5">

		<form asp-action="CheckOut" asp-controller="Cart" method="post" id="checkoutForm">
			@Html.AntiForgeryToken()

			<div class="row g-5">

				<!-- LEFT: FORM -->
				<div class="col-md-12 col-lg-6 col-xl-7">
					<h4 class="mb-4">Thông tin giao hàng</h4>

					<div class="form-check my-3">
						<input type="hidden" name="GiongKhachHang" value="false" />

						<input type="checkbox"
							   name="GiongKhachHang"
							   id="GiongKhachHang"
							   value="true"
							   class="form-check-input" />

						<label class="form-check-label" for="GiongKhachHang">
							Giống thông tin khách hàng?
						</label>
					</div>

					<div class="delivery-info">
						<div class="mb-3">
							<label class="form-label">Người nhận hàng *</label>
							<input type="text" name="HoTen" class="form-control" />
						</div>

						<div class="mb-3">
							<label class="form-label">Địa chỉ *</label>
							<input type="text" name="DiaChi" class="form-control" />
						</div>

						<div class="mb-3">
							<label class="form-label">Điện thoại *</label>
							<input type="text" name="DienThoai" class="form-control" />
						</div>
					</div>

					<div class="mb-3">
						<label class="form-label">Ghi chú</label>
						<textarea name="GhiChu"
								  class="form-control"
								  rows="4"
								  placeholder="Ghi chú cho đơn hàng"></textarea>
					</div>
					<button type="submit"
							formaction="/Cart/PayWithVnpay"
							class="btn btn-danger w-100 mt-3">
						Thanh toán VNPAY
					</button>
					<div id="paypal-button-container" class="mt-3"></div>
					<button type="submit"
							class="btn border-secondary py-3 px-4 mt-3 text-uppercase w-100 text-primary">
						Hoàn tất đặt hàng
					</button>
				</div>

				<!-- RIGHT: CART -->
				<div class="col-md-12 col-lg-6 col-xl-5">
					<div class="table-responsive">
						<table class="table">
							<thead>
								<tr>
									<th>Sản phẩm</th>
									<th>Tên</th>
									<th>Giá</th>
									<th>SL</th>
									<th>Tổng</th>
								</tr>
							</thead>
							<tbody>
								@foreach (var item in Model)
								{
									<tr>
										<td>
											<img src="~/Hinh/HangHoa/@item.Hinh"
												 style="width:70px;height:70px"
												 class="img-fluid rounded-circle" />
										</td>
										<td>@item.TenHH</td>
										<td>
											@string.Format("{0:N0} ₫", item.DonGia)
										</td>
										<td>@item.SoLuong</td>
										<td>@item.ThanhTien.ToString("#,##0")</td>
									</tr>
								}

								<tr>
									<td colspan="4" class="text-end fw-bold">Tổng cộng</td>
									<td class="fw-bold text-danger">
										@Model.Sum(x => x.ThanhTien).ToString("#,##0") ₫
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>

			</div>
		</form>
	</div>
</div>

@section Scripts {
	<script>
		$(function () {
			$("#GiongKhachHang").change(function () {
				$(".delivery-info").toggleClass("d-none", this.checked);
			});
		});
	</script>
    <script>
        $(function () {
            $("#GiongKhachHang").change(function () {
                $(".delivery-info").toggleClass("d-none", this.checked);
            });
        });
    </script>

    <script src="https://www.paypal.com/sdk/js?client-id=Abb3hkgAAStKCLpDaAiaL4hPbgjYHxq4r3mm0zyGJJnjzEcSRqpENq_wBfB0-D1WoSpLnE-8vx84_b5f&currency=USD"></script>

	<script>
		paypal.Buttons({
			createOrder: function(data, actions) {
				var vndAmount = parseFloat('@totalAmountVND');
				var usdAmount = (vndAmount / 25000).toFixed(2);
				return actions.order.create({
					purchase_units: [{
						amount: { value: usdAmount }
					}]
				});
			},
			onApprove: function(data, actions) {
				return actions.order.capture().then(function(details) {
					// Sử dụng AJAX để gửi dữ liệu về Action PayWithPaypal
					$.ajax({
						url: "/Cart/PayWithPaypal",
						type: "POST",
						data: $("#checkoutForm").serialize(),
						success: function(response) {
							if (response.success) {
								window.location.href = "/Cart/Success";
							}
						},
						error: function() {
							alert("Lỗi hệ thống khi lưu đơn hàng PayPal.");
						}
					});
				});
			},
			onCancel: function (data) {
				alert("Bạn đã hủy giao dịch PayPal.");
			}
		}).render('#paypal-button-container'); // Render vào đúng ID container đã tạo
	</script>
}
